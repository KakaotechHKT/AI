name: Build and Test (Backend Docker)

on:
  pull_request:
    branches:
      - main
      - dev

jobs:
  build-test:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: "ai-test:latest"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker Image
        run: |
          echo "ğŸš€ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘: $IMAGE_NAME"

          docker build -t "$IMAGE_NAME" \
            --build-arg DB_HOST="${{ secrets.DB_HOST }}" \
            --build-arg DB_NAME="${{ secrets.DB_NAME }}" \
            --build-arg DB_USER="${{ secrets.DB_USER }}" \
            --build-arg DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            --build-arg OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            --build-arg GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" \
            .

      - name: Run Container for Testing
        run: |
          echo "ğŸ› ï¸ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ë° í…ŒìŠ¤íŠ¸"

          docker run -d --name ai-test-container -p 8000:8000 "$IMAGE_NAME"

          # ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ”ì§€ í™•ì¸
          sleep 10
          docker ps -a

          # ë¡œê·¸ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
          docker logs ai-test-container

      - name: Cleanup
        run: |
          echo "ğŸ§¹ Docker ì»¨í…Œì´ë„ˆ ë° ì´ë¯¸ì§€ ì •ë¦¬"
          docker stop ai-test-container
          docker rm ai-test-container
          docker rmi "$IMAGE_NAME"