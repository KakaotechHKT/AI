name: Build GCE Image for AI Auto-Scale

on:
  push:
    branches:
      - disabled-main #disabled

jobs:
  build-gce-image:
    name: Build GCE Image for AI
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set image name for GCE
        run: |
          IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/babpat-ai:latest"
          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV

      - name: Build and Push Docker Image
        run: |
          docker build -t "$IMAGE_NAME" .
          docker push "$IMAGE_NAME"

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}'

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v1

      - name: Create GCE Image from Docker Container
        run: |
          export IMAGE_NAME="${IMAGE_NAME}"
          export INSTANCE_NAME="babpat-ai-image"
          export PROJECT_ID="${{ secrets.GCP_PROJECT }}"
          export ZONE="asia-northeast3-a"
          export FAMILY="babpat-ai-family"
          export CONTAINER_NAME="babpat-ai"
          export MACHINE_TYPE="e2-medium"
          export DISK_SIZE="10GB"

          echo "ğŸ”¹ 1. ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ ì‚­ì œ (ìˆë‹¤ë©´)"
          gcloud compute instances delete "$INSTANCE_NAME" \
            --zone="$ZONE" \
            --quiet \
            --project="$PROJECT_ID" || true

          echo "ğŸ”¹ 2. ì¸ìŠ¤í„´ìŠ¤ ìƒì„± (startup-script ì—†ì´)"
          gcloud compute instances create "$INSTANCE_NAME" \
            --zone="$ZONE" \
            --machine-type="$MACHINE_TYPE" \
            --image-family=ubuntu-2204-lts \
            --image-project=ubuntu-os-cloud \
            --boot-disk-size="$DISK_SIZE" \
            --project="$PROJECT_ID" \
            --format="get(networkInterfaces[0].accessConfigs[0].natIP)" \
            --quiet > external_ip.txt

          export EXTERNAL_IP=$(cat external_ip.txt | tr -d '\n')
          echo "âœ… ì¸ìŠ¤í„´ìŠ¤ External IP: $EXTERNAL_IP"

          echo "â³ ì¸ìŠ¤í„´ìŠ¤ ì¤€ë¹„ ëŒ€ê¸° (30ì´ˆ)"
          sleep 30

          echo "ğŸ”¹ 3. .env ìƒì„±"
          touch .env
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> .env
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> .env
          echo "DB_USER=${{ secrets.DB_USER }}" >> .env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env

          echo "ğŸ”¹ 4. SSH Key ì €ì¥"
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > key.pem
          chmod 600 key.pem

          echo "ğŸ”¹ 5. ì¸ìŠ¤í„´ìŠ¤ë¡œ .env ì „ì†¡"
          scp -o StrictHostKeyChecking=no -i key.pem .env ubuntu@$EXTERNAL_IP:/tmp/.env

          echo "ğŸ”¹ 6. ì¸ìŠ¤í„´ìŠ¤ì—ì„œ docker pull & save"
          ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@$EXTERNAL_IP <<EOF
            set -e
            sudo apt update && sudo apt install -y docker.io

            echo "ğŸ“¦ Docker ë¡œê·¸ì¸"
            echo "${{ secrets.DOCKER_PASSWORD }}" | sudo docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            echo "ğŸ“¦ Docker ì´ë¯¸ì§€ Pull"
            sudo docker pull "$IMAGE_NAME"

            echo "ğŸ“¦ .env ë””ë ‰í† ë¦¬ ìƒì„± ë° ì´ë™"
            sudo mkdir -p /opt/app
            sudo mv /tmp/.env /opt/app/.env

            echo "ğŸ“¦ Docker ì´ë¯¸ì§€ Save"
            sudo docker save "$IMAGE_NAME" | sudo tee /opt/app/app.tar > /dev/null

            echo "âœ… ì¸ìŠ¤í„´ìŠ¤ì— .env + app.tar ì €ì¥ ì™„ë£Œ"
          EOF

          echo "ğŸ”¹ 7. ì¸ìŠ¤í„´ìŠ¤ ì¢…ë£Œ"
          gcloud compute instances stop "$INSTANCE_NAME" \
            --zone="$ZONE" \
            --project="$PROJECT_ID" \
            --quiet

          echo "ğŸ”¹ 8. ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ (ìˆë‹¤ë©´)"
          gcloud compute images delete "$INSTANCE_NAME-img" --quiet --project="$PROJECT_ID" || true

          echo "ğŸ”¹ 9. ë””ìŠ¤í¬ë¡œë¶€í„° ì´ë¯¸ì§€ ìƒì„±"
          gcloud compute images create "$INSTANCE_NAME-img" \
            --source-disk="$INSTANCE_NAME" \
            --source-disk-zone="$ZONE" \
            --family="$FAMILY" \
            --project="$PROJECT_ID" \
            --quiet

          echo "ğŸ”¹ 10. ì¸ìŠ¤í„´ìŠ¤ ì‚­ì œ"
          gcloud compute instances delete "$INSTANCE_NAME" \
            --zone="$ZONE" \
            --quiet \
            --project="$PROJECT_ID"

          echo "âœ… GCE ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ: $INSTANCE_NAME-img (family: $FAMILY)"


      - name: Destroy All MIG Instances (babpat-ai)
        run: |
          INSTANCES=$(gcloud compute instance-groups managed list-instances babpat-ai \
            --region=asia-northeast3 \
            --format="value(instance.basename())" | paste -sd "," -)

          if [ -z "$INSTANCES" ]; then
            echo "âš ï¸ No instances to delete"
          else
            echo "ğŸ”¥ Deleting instances: $INSTANCES"
            if ! gcloud compute instance-groups managed delete-instances babpat-ai \
              --region=asia-northeast3 \
              --instances=$INSTANCES \
              --quiet; then
              echo "âš ï¸ Some instances might already be deleting or failed. Continuing anyway."
            fi
          fi